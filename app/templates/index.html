{% extends "base.html" %}

{% block title %}ğŸ  é¦–é¡µ - {{ config.SITE_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
        <h1>ğŸ³ {{ config.SITE_NAME }}</h1>
            <button id="adminModeBtn" class="btn admin-btn" title="ç®¡ç†æ¨¡å¼">
                <span class="admin-icon">âš™ï¸</span>
            </button>
        </div>
        <button class="btn btn-primary btn-lg admin-only mt-3" onclick="initializeRecipeModal('create')" style="display: none;">
            âœ¨ åˆ›å»ºæ–°èœè°±
        </button>
    </div>
</div>

<div class="row">
    {% for recipe in recipes %}
    <div class="col-md-4 mb-4">
        <div class="card {% if recipe.final_images|length > 0 %}h-100{% endif %}">
            {% if recipe.final_images|length > 0 %}
            <a href="{{ url_for('main.recipe', recipe_id=recipe.id) }}">
                <img src="{{ url_for('static', filename=(recipe.final_images|sort(attribute='order'))[0].image_path.replace('\\', '/')) }}" 
                     class="card-img-top" 
                     alt="{{ recipe.name }}" 
                     style="height: 200px; object-fit: cover;">
            </a>
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">ğŸ½ï¸ {{ recipe.name }}</h5>
                <div class="ingredients-tags mb-3">
                    {% for ingredient in recipe.ingredients %}
                    <span class="badge bg-light text-dark border me-1 mb-1">
                        ğŸ”¸ {{ ingredient.name }}
                        {% if ingredient.amount %}
                        <small class="text-muted">{{ ingredient.amount }}</small>
                        {% endif %}
                    </span>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        ğŸ“… {{ recipe.created_at.strftime('%Y-%m-%d') }}
                    </small>
                    <div class="btn-group">
                        <a href="{{ url_for('main.recipe', recipe_id=recipe.id) }}" class="btn btn-sm btn-primary">ğŸ‘€ æŸ¥çœ‹</a>
                        <button class="btn btn-sm btn-primary edit-recipe admin-only" onclick="loadRecipeForEdit('{{ recipe.id }}')" style="display: none;">âœï¸ ç¼–è¾‘</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            ğŸ¯ è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èœè°±ã€‚{% if is_admin %}ç‚¹å‡»ä¸Šæ–¹çš„"åˆ›å»ºæ–°èœè°±"æŒ‰é’®å¼€å§‹æ·»åŠ å§ï¼{% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% include 'recipe_edit_modal.html' %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common_ingredients.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ ¹æ®ç®¡ç†æ¨¡å¼çŠ¶æ€æ˜¾ç¤º/éšè—ç®¡ç†åŠŸèƒ½
    function updateAdminElements(isAdmin) {
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? 'inline-block' : 'none';
        });
    }

    // ç›‘å¬ç®¡ç†æ¨¡å¼çŠ¶æ€å˜åŒ–
    window.addEventListener('adminModeChanged', function(e) {
        updateAdminElements(e.detail.isAdmin);
    });

    // ä¿®æ”¹ç®¡ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    window.toggleAdminMode = function() {
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        if (isAdmin) {
            // å¦‚æœå·²ç»æ˜¯ç®¡ç†æ¨¡å¼ï¼Œæ˜¾ç¤ºç®¡ç†æ¨¡æ€çª—å£
            const adminModal = new bootstrap.Modal(document.getElementById('adminModal'));
            adminModal.show();
        } else {
            // å¦‚æœä¸æ˜¯ç®¡ç†æ¨¡å¼ï¼Œæ˜¾ç¤ºç™»å½•æ¨¡æ€çª—å£
            const loginModal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
            loginModal.show();
        }
    };

    // åˆå§‹åŒ–ç®¡ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const adminBtn = document.getElementById('adminModeBtn');
    if (adminBtn) {
        adminBtn.onclick = toggleAdminMode;
    }

    // åˆå§‹çŠ¶æ€æ›´æ–°
    updateAdminElements(localStorage.getItem('isAdmin') === 'true');

    // åŠ è½½èœè°±æ•°æ®è¿›è¡Œç¼–è¾‘
    window.loadRecipeForEdit = function(recipeId) {
        fetch(`/recipe/${recipeId}/edit`)
            .then(response => response.json())
            .then(recipe => {
                initializeRecipeModal('edit', recipe);
            })
            .catch(error => {
                console.error('åŠ è½½èœè°±æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½èœè°±æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
    };

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .recipe-img {
            height: 200px;
            object-fit: cover;
        }
        .ingredients-tags {
            min-height: 50px;
            max-height: 100px;
            overflow-y: auto;
        }
        .badge {
            font-weight: normal;
            font-size: 0.9em;
            padding: 5px 8px;
        }
        .badge small {
            font-size: 0.85em;
            opacity: 0.8;
        }
        .card {
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .card-img-container {
            background-color: #f8f9fa;
            overflow: hidden;
        }
        .card-img-container img {
            transition: transform 0.3s ease;
        }
        .card:hover .card-img-container img {
            transform: scale(1.05);
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %} 