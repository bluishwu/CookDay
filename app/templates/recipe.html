{% extends "base.html" %}

{% block title %}{{ recipe.name }} - {{ config.SITE_NAME }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
    <div class="col-md-8">
            <h1 class="mb-4">
                <a href="/" style="text-decoration: none; color: inherit;">ğŸ½ï¸ {{ recipe.name }}</a>
            </h1>
            <p class="text-muted">
                ğŸ“… åˆ›å»ºäº {{ recipe.created_at.strftime('%Y-%m-%d') }}
                {% if recipe.updated_at and recipe.updated_at != recipe.created_at %}
                | âœï¸ æœ€åç¼–è¾‘äº {{ recipe.updated_at.strftime('%Y-%m-%d') }}
                {% endif %}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary me-2" onclick="showShareModal()">
                ğŸ“¤ åˆ†äº«èœè°±
            </button>
            <button class="btn btn-primary admin-only" onclick="loadRecipeForEdit('{{ recipe.id }}')" style="display: none;">
                âœï¸ ç¼–è¾‘èœè°±
            </button>
        </div>
        </div>

    <!-- åˆ†äº«é€‰é¡¹æ¨¡æ€çª—å£ -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“¤ åˆ†äº«èœè°±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æ ‡é¢˜è®¾ç½®ï¼š</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareTitle" checked>
                            <label class="form-check-label" for="shareTitle">
                                ğŸ·ï¸ æ˜¾ç¤ºæ ‡é¢˜
                            </label>
                        </div>
                        <div class="mt-2" id="titleCustomizeArea" style="padding-left: 24px;">
                            <input type="text" class="form-control form-control-sm mb-2" id="customTitle" placeholder="è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨èœåï¼‰">
                            <input type="text" class="form-control form-control-sm" id="customSubtitle" placeholder="è‡ªå®šä¹‰å‰¯æ ‡é¢˜" value="æˆ‘çš„ç¾å‘³èœè°±é›†">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è¦åŒ…å«çš„å†…å®¹ï¼š</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareDescription" checked>
                            <label class="form-check-label" for="shareDescription">
                                ğŸ“ æè¿°
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareIngredients" checked>
                            <label class="form-check-label" for="shareIngredients">
                                ğŸ¥˜ é£Ÿæå‡†å¤‡
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareSteps" checked>
                            <label class="form-check-label" for="shareSteps">
                                ğŸ“ åˆ¶ä½œæ­¥éª¤
                            </label>
            </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareNotes" checked>
                            <label class="form-check-label" for="shareNotes">
                                ğŸ“’ æ”¹è¿›ç¬”è®°
                            </label>
        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareFinalImage">
                            <label class="form-check-label" for="shareFinalImage">
                                ğŸ“¸ æˆå“å›¾ç‰‡
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="generateShareImage()">
                        ğŸ“¸ ç”Ÿæˆåˆ†äº«å›¾
            </button>
                </div>
        </div>
    </div>
</div>

    <!-- åˆ†äº«é¢„è§ˆæ¨¡æ€çª—å£ -->
    <div class="modal fade" id="sharePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                    <h5 class="modal-title">ğŸ“¸ åˆ†äº«é¢„è§ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                    <div id="sharePreview" class="bg-white p-4">
                        <!-- åˆ†äº«å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="backToShareOptions()">è¿”å›é€‰é¡¹</button>
                    <button type="button" class="btn btn-primary" onclick="downloadShareImage()">
                        ğŸ’¾ ä¿å­˜å›¾ç‰‡
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if recipe.description %}
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>ğŸ“ æè¿°</h3>
            </div>
            <div class="card">
                <div class="card-body">
                    <p class="recipe-description mb-0" style="white-space: pre-wrap;">{{ recipe.description }}</p>
</div>
            </div>
            <div class="video-preview mt-2"></div>
        </div>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>ğŸ¥˜ é£Ÿæå‡†å¤‡</h3>
                <div class="btn-group" style="border-radius: 20px; overflow: hidden;">
                    <button type="button" class="btn btn-sm view-btn view-btn-active" style="border-radius: 20px 0 0 20px !important;" onclick="switchIngredientsView('compact')" title="æ ‡ç­¾è§†å›¾">
                        ğŸ·ï¸
                    </button>
                    <button type="button" class="btn btn-sm view-btn" style="border-radius: 0 20px 20px 0 !important;" onclick="switchIngredientsView('table')" title="è¡¨æ ¼è§†å›¾">
                        ğŸ“‹
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <!-- ç´§å‡‘è§†å›¾ -->
                    <div id="compactView" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for ingredient in recipe.ingredients %}
                        <span class="badge bg-light text-dark border">
                            ğŸ”¸ {{ ingredient.name }}
                            {% if ingredient.amount %} {{ ingredient.amount }}{% endif %}
                            {% if ingredient.note %}ğŸ“{{ ingredient.note }}{% endif %}
                        </span>
                        {% endfor %}
                    </div>
                    <!-- è¡¨æ ¼è§†å›¾ -->
                    <div id="tableView" style="display: none;">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>ğŸ¥— é£Ÿæ</th>
                                        <th>ğŸ“ ç”¨é‡</th>
                                        <th>ğŸ“Œ å¤‡æ³¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ingredient in recipe.ingredients %}
                                    <tr>
                                        <td>ğŸ”¸ {{ ingredient.name }}</td>
                                        <td>{{ ingredient.amount }}</td>
                                        <td>{% if ingredient.note %}ğŸ“ {{ ingredient.note }}{% endif %}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                    </div>
                    </div>
            </div>
        </div>
    </div>
</div>

    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>ğŸ“ åˆ¶ä½œæ­¥éª¤</h3>
            </div>
            <div class="mt-3">
                {% for step in recipe.steps %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">âœ¨ æ­¥éª¤ {{ loop.index }}</h5>
                        <p class="card-text step-description" style="white-space: pre-wrap;" data-ingredients='{{ recipe.ingredients|map(attribute="name")|list|tojson|safe }}'>{{ step.description }}</p>
                        {% if step.image_path %}
                        <img src="{{ url_for('static', filename=step.image_path.replace('\\', '/')) }}" class="img-fluid rounded" alt="æ­¥éª¤å›¾ç‰‡">
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
        </div>
    </div>
</div>

    {% if recipe.notes %}
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>ğŸ“’ æ”¹è¿›ç¬”è®°</h3>
            </div>
            <div class="mt-3">
                {% for note in recipe.notes %}
                <div class="card mb-3">
                    <div class="card-body">
                        <small class="text-muted mb-2 d-block">ğŸ“… {{ note.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        <p class="card-text" style="white-space: pre-wrap;">{{ note.content }}</p>
                        {% if note.image_path %}
                        <img src="{{ url_for('static', filename=note.image_path.replace('\\', '/')) }}" class="img-fluid rounded" alt="ç¬”è®°å›¾ç‰‡">
                        {% endif %}
                    </div>
            </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if recipe.final_images %}
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>ğŸ“¸ æˆå“å›¾ç‰‡</h3>
            </div>
            <div class="final-images-container" id="finalImagesContainer">
                {% for image in recipe.final_images|sort(attribute='order') %}
                <div class="final-image-item mb-3" data-id="{{ image.id }}">
                    <div class="position-relative">
                        <img src="{{ url_for('static', filename=image.image_path.replace('\\', '/')) }}" 
                             class="img-fluid rounded" 
                             alt="æˆå“å›¾ç‰‡"
                             onclick="showOriginalImage(this.src)"
                             style="cursor: zoom-in;">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€çª—å£ -->
    <div class="modal fade" id="imageViewModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen m-0">
            <div class="modal-content">
                <div class="modal-body p-0 d-flex align-items-center justify-content-center" style="min-height: 100vh;" onclick="closeImageModal(event)">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-4" data-bs-dismiss="modal"></button>
                    <button type="button" class="btn btn-prev" onclick="prevImage(event)">
                        <i class="fs-1">â®</i>
                    </button>
                    <img id="originalImage" class="img-fluid" alt="åŸå›¾" style="max-height: 100vh; width: auto; object-fit: contain;">
                    <button type="button" class="btn btn-next" onclick="nextImage(event)">
                        <i class="fs-1">â¯</i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'recipe_edit_modal.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common_ingredients.js') }}"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ ¹æ®ç®¡ç†æ¨¡å¼çŠ¶æ€æ˜¾ç¤º/éšè—ç®¡ç†åŠŸèƒ½
    function updateAdminElements(isAdmin) {
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? 'inline-block' : 'none';
        });
    }

    // ç›‘å¬ç®¡ç†æ¨¡å¼çŠ¶æ€å˜åŒ–
    window.addEventListener('adminModeChanged', function(e) {
        updateAdminElements(e.detail.isAdmin);
    });

    // åˆå§‹çŠ¶æ€æ›´æ–°
    updateAdminElements(localStorage.getItem('isAdmin') === 'true');

    // åŠ è½½èœè°±æ•°æ®è¿›è¡Œç¼–è¾‘
    window.loadRecipeForEdit = function(recipeId) {
        fetch(`/recipe/${recipeId}/edit`)
            .then(response => response.json())
            .then(recipe => {
                initializeRecipeModal('edit', recipe);
            })
            .catch(error => {
                console.error('åŠ è½½èœè°±æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½èœè°±æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
    };

    // æ£€æŸ¥æè¿°ä¸­çš„è§†é¢‘é“¾æ¥
    const description = document.querySelector('.recipe-description');
    if (description) {
        const container = description.closest('.col');
        handleVideoLink(description.textContent, container);
    }

    // é«˜äº®æ­¥éª¤ä¸­çš„é£Ÿæ
    function highlightIngredients() {
        // è·å–æ‰€æœ‰é£Ÿæåç§°ï¼ˆä»é£Ÿæè¡¨æ ¼çš„ç¬¬ä¸€åˆ—ï¼‰
        const ingredients = Array.from(document.querySelectorAll('table tbody tr td:first-child')).map(el => {
            const name = el.textContent.trim();
            // å»é™¤emojiå’Œå‰åç©ºæ ¼
            const cleanName = name.replace(/[\u{1F300}-\u{1F9FF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{1F191}-\u{1F251}]|[\u{1F004}]|[\u{1F0CF}]|[\u{1F170}-\u{1F171}]|[\u{1F17E}-\u{1F17F}]|[\u{1F18E}]|[\u{3030}]|[\u{2B50}]|[\u{2B55}]|[\u{2934}-\u{2935}]|[\u{2B05}-\u{2B07}]|[\u{2B1B}-\u{2B1C}]|[\u{3297}]|[\u{3299}]|[\u{303D}]|[\u{00A9}]|[\u{00AE}]|[\u{2122}]/gu, '').trim();
            return cleanName;
        }).filter(name => name); // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²

        // è·å–æ‰€æœ‰æ­¥éª¤æè¿°
        const steps = document.querySelectorAll('.step-description');
        steps.forEach((step, index) => {
            let content = step.textContent; // å…ˆè·å–çº¯æ–‡æœ¬å†…å®¹

            // ä¸ºæ¯ä¸ªé£Ÿæåˆ›å»ºé«˜äº®ï¼ŒæŒ‰é•¿åº¦æ’åºä»¥ç¡®ä¿å…ˆåŒ¹é…è¾ƒé•¿çš„é£Ÿæåç§°
            ingredients.sort((a, b) => b.length - a.length).forEach(ingredient => {
                if (ingredient) {
                    // åˆ›å»ºä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…é£Ÿæåç§°
                    const regex = new RegExp(ingredient, 'g');
                    const matches = content.match(regex);
                    if (matches) {
                        content = content.replace(regex, `<span class="ingredient-highlight">$&</span>`);
                    }
                }
            });

            step.innerHTML = content;
        });
    }

    // æ·»åŠ é«˜äº®æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .ingredient-highlight {
            background-color: #e3f2fd;
            border-radius: 3px;
            padding: 2px 4px;
            font-weight: bold;
            color: #1976d2;
            display: inline-block;
            line-height: 1.2;
            margin: 0 2px;
        }
        .video-preview {
            margin: 10px 0;
        }
        /* ä¿®æ”¹è§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .view-btn {
            color: #ff9999 !important;
            border: 1px solid #ff9999 !important;
            background-color: transparent !important;
            transition: background-color 0.2s ease, color 0.2s ease !important;
            min-width: 40px;
            padding: 0.25rem 0.5rem;
        }
        .view-btn:hover {
            color: white !important;
            background-color: #ff9999 !important;
        }
        .view-btn-active {
            color: white !important;
            background-color: #ff9999 !important;
            border-color: #ff9999 !important;
        }
        /* ç§»é™¤æŒ‰é’®ç»„çš„é»˜è®¤åœ†è§’æ ·å¼ */
        .btn-group > .btn {
            border-radius: 0 !important;
        }
        .btn-group > .btn:first-child {
            border-radius: 20px 0 0 20px !important;
        }
        .btn-group > .btn:last-child {
            border-radius: 0 20px 20px 0 !important;
        }
    `;
    document.head.appendChild(style);

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œé«˜äº®
    highlightIngredients();

    // ç»Ÿä¸€çš„é“¾æ¥è§£æå¤„ç†å‡½æ•°
    function handleVideoLink(text, container) {
        // å¦‚æœæ–‡æœ¬ä¸ºç©ºï¼Œç›´æ¥è¿”å›
        if (!text || !text.trim()) {
            return;
        }

        // åŒ¹é…æ‰€æœ‰URL
        const urlRegex = /https?:\/\/[^\s]+/g;
        const urls = text.match(urlRegex);
        
        if (urls) {
            urls.forEach(url => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªé“¾æ¥
                const existingPreview = container.querySelector(`[data-video-link="${url}"]`);
                if (existingPreview) {
                    return;
                }
                
                fetch('/parse_video_url', {
            method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                        const preview = document.createElement('div');
                        preview.className = 'video-preview mt-2';
                        preview.setAttribute('data-video-link', url);
                        
                        // æ ¹æ®URLåˆ¤æ–­å¹³å°
                        let platform = 'ğŸ”—';
                        if (url.includes('douyin.com')) {
                            platform = 'ğŸµ';
                        } else if (url.includes('bilibili.com')) {
                            platform = 'ğŸ“º';
                        }
                        
                        preview.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <span class="platform-icon me-2">${platform}</span>
                                        <span class="video-title">${data.data.title}</span>
                                        <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary ms-auto">
                                            æŸ¥çœ‹é“¾æ¥
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        const previewContainer = container.querySelector('.video-preview');
                        if (previewContainer) {
                            previewContainer.innerHTML = preview.innerHTML;
                        }
            }
        });
    });
        }
    }

    // åˆ†äº«åŠŸèƒ½ç›¸å…³ä»£ç 
    window.showShareModal = function() {
        const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
        // è®¾ç½®é»˜è®¤æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
        document.getElementById('customTitle').value = document.querySelector('h1').textContent.trim();
        document.getElementById('customSubtitle').value = document.title.split(' - ')[1];
        shareModal.show();
    };

    window.backToShareOptions = function() {
        const sharePreviewModal = bootstrap.Modal.getInstance(document.getElementById('sharePreviewModal'));
        sharePreviewModal.hide();
        showShareModal();
    };

    window.generateShareImage = function() {
        // è·å–é€‰ä¸­çš„é€‰é¡¹
        const includeTitle = document.getElementById('shareTitle').checked;
        const customTitle = document.getElementById('customTitle').value.trim();
        const customSubtitle = document.getElementById('customSubtitle').value.trim();
        const includeDescription = document.getElementById('shareDescription').checked;
        const includeIngredients = document.getElementById('shareIngredients').checked;
        const includeSteps = document.getElementById('shareSteps').checked;
        const includeNotes = document.getElementById('shareNotes').checked;
        const includeFinalImage = document.getElementById('shareFinalImage').checked;

        console.log('åˆ†äº«é€‰é¡¹:', {
            includeTitle,
            customTitle,
            customSubtitle,
            includeDescription,
            includeIngredients,
            includeSteps,
            includeNotes,
            includeFinalImage
        });

        // åˆ›å»ºåˆ†äº«é¢„è§ˆå†…å®¹
        const sharePreview = document.getElementById('sharePreview');
        sharePreview.innerHTML = '';

        // æ·»åŠ æ ‡é¢˜
        if (includeTitle) {
            const titleDiv = document.createElement('div');
            titleDiv.className = 'mb-4 text-center';
            titleDiv.innerHTML = `
                <h2 class="mb-3">${customTitle || document.querySelector('h1').textContent.trim()}</h2>
                <div class="text-muted small">${customSubtitle}</div>
            `;
            sharePreview.appendChild(titleDiv);
        }

        // æ·»åŠ æˆå“å›¾ç‰‡ï¼ˆåªåœ¨å‹¾é€‰æ—¶æ·»åŠ ï¼‰
        if (includeFinalImage) {
            console.log('æ·»åŠ æˆå“å›¾ç‰‡åˆ°é¢„è§ˆ');
            const finalImages = document.querySelectorAll('.final-image-item');
            if (finalImages.length > 0) {
                const imagesDiv = document.createElement('div');
                imagesDiv.className = 'mb-4';
                imagesDiv.innerHTML = `
                    <h4>ğŸ“¸ æˆå“å›¾ç‰‡</h4>
                    <div class="final-images-container" id="sharePreviewImages">
                        ${Array.from(finalImages).map(item => {
                            const image = item.querySelector('img');
                            // åˆ›å»ºä¸€ä¸ªæ–°çš„ canvas å…ƒç´ æ¥å­˜å‚¨å›¾ç‰‡æ•°æ®
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = image.naturalWidth;
                            canvas.height = image.naturalHeight;
                            ctx.drawImage(image, 0, 0);
                            // ä½¿ç”¨ canvas çš„ dataURL ä½œä¸ºå›¾ç‰‡æº
                            return `
                                <div class="final-image-item mb-3" data-id="${item.dataset.id}">
                                    <div class="position-relative">
                                        <img src="${canvas.toDataURL()}" class="img-fluid rounded" alt="æˆå“å›¾ç‰‡">
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                sharePreview.appendChild(imagesDiv);

                // åªåœ¨ç®¡ç†æ¨¡å¼ä¸‹åˆå§‹åŒ–åˆ†äº«é¢„è§ˆä¸­çš„å›¾ç‰‡æ’åº
                if (localStorage.getItem('isAdmin') === 'true') {
                    new Sortable(document.getElementById('sharePreviewImages'), {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: function(evt) {
                            // è·å–æ–°çš„æ’åºé¡ºåº
                            const newOrder = Array.from(evt.target.children).map((item, index) => ({
                                id: parseInt(item.dataset.id),
                                order: index
                            }));
                            
                            // æ›´æ–°ä¸»è§†å›¾ä¸­çš„å›¾ç‰‡é¡ºåº
                            const mainContainer = document.getElementById('finalImagesContainer');
                            if (mainContainer) {
                                newOrder.forEach(({id}) => {
                                    const item = mainContainer.querySelector(`[data-id="${id}"]`);
                                    if (item) mainContainer.appendChild(item);
                                });
                            }
                            
                            // å‘é€æ’åºè¯·æ±‚åˆ°æœåŠ¡å™¨
                            fetch(`/recipe/{{ recipe.id }}/final_images/reorder`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(newOrder)
                            });
                        }
                    });
                }
            }
        } else {
            console.log('è·³è¿‡æ·»åŠ æˆå“å›¾ç‰‡');
        }

        // æ·»åŠ æè¿°
        if (includeDescription) {
            const description = document.querySelector('.recipe-description');
            if (description && description.textContent.trim()) {
                const descDiv = document.createElement('div');
                descDiv.className = 'mb-4';
                descDiv.innerHTML = `
                    <h4>ğŸ“ æè¿°</h4>
                    <p style="white-space: pre-wrap;">${description.textContent}</p>
                `;
                sharePreview.appendChild(descDiv);
            }
        }

        // æ·»åŠ é£Ÿæ
        if (includeIngredients) {
            const ingredients = Array.from(document.querySelectorAll('table tbody tr')).map(row => {
                const name = row.cells[0].textContent.trim();
                const amount = row.cells[1].textContent.trim();
                const note = row.cells[2].textContent.trim();
                return { name, amount, note };
            });

            if (ingredients.length > 0) {
                const ingredientsDiv = document.createElement('div');
                ingredientsDiv.className = 'mb-4';
                ingredientsDiv.innerHTML = `
                    <h4>ğŸ¥˜ é£Ÿæå‡†å¤‡</h4>
                    <div class="card">
                        <div class="card-body">
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${ingredients.map(ing => {
                                    let text = `ğŸ”¸ ${ing.name.replace('ğŸ”¸', '').trim()}`;
                                    if (ing.amount) text += ` ${ing.amount}`;
                                    if (ing.note) text += ` ğŸ“${ing.note.replace('ğŸ“', '').trim()}`;
                                    return `<span class="badge bg-light text-dark border">${text}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                sharePreview.appendChild(ingredientsDiv);
            }
        }

        // æ·»åŠ æ­¥éª¤
        if (includeSteps) {
            const steps = Array.from(document.querySelectorAll('.step-description')).map((step, index) => {
                return `
                    <div class="card mb-2" style="border-left: 3px solid #ffb6c1; border-radius: 4px;">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="step-number me-2" style="width: 24px; height: 24px; background-color: #ffb6c1; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                    ${index + 1}
                                </div>
                                <p class="mb-0" style="white-space: pre-wrap;">${step.innerHTML}</p>
                            </div>
                            ${step.image_path ? `<img src="${step.image_path}" class="img-fluid mt-2" style="max-height: 200px; object-fit: contain;">` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            if (steps) {
                const stepsDiv = document.createElement('div');
                stepsDiv.className = 'mb-4';
                stepsDiv.innerHTML = `
                    <h4>ğŸ“ åˆ¶ä½œæ­¥éª¤</h4>
                    ${steps}
                `;
                sharePreview.appendChild(stepsDiv);
            }
        }

        // æ·»åŠ ç¬”è®°
        if (includeNotes) {
            const notes = Array.from(document.querySelectorAll('.row .card:has(.card-text)')).map(note => {
                if (!note.closest('.row').querySelector('h3')?.textContent.includes('æ”¹è¿›ç¬”è®°')) {
                    return null;
                }
                const content = note.querySelector('.card-text').textContent;
                const date = note.querySelector('.text-muted').textContent;
                return `
                    <div class="card mb-2" style="border-left: 3px solid #b6c1ff; border-radius: 4px;">
                        <div class="card-body py-2">
                            <small class="text-muted d-block mb-1">${date}</small>
                            <p class="card-text mb-0" style="white-space: pre-wrap;">${content}</p>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');

            if (notes) {
                const notesDiv = document.createElement('div');
                notesDiv.className = 'mb-4';
                notesDiv.innerHTML = `
                    <h4>ğŸ“’ æ”¹è¿›ç¬”è®°</h4>
                    ${notes}
                `;
                sharePreview.appendChild(notesDiv);
            }
        }

        // æ·»åŠ æ°´å°
        const watermark = document.createElement('div');
        watermark.className = 'text-center text-muted mt-3 pt-2 border-top';
        watermark.innerHTML = `
            <small>CookDay - ${new Date().toLocaleDateString('zh-CN')}</small>
        `;
        sharePreview.appendChild(watermark);

        // éšè—åˆ†äº«é€‰é¡¹æ¨¡æ€çª—å£ï¼Œæ˜¾ç¤ºé¢„è§ˆæ¨¡æ€çª—å£
        const shareModal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
        shareModal.hide();
        const sharePreviewModal = new bootstrap.Modal(document.getElementById('sharePreviewModal'));
        sharePreviewModal.show();
    };

    window.downloadShareImage = function() {
        const sharePreview = document.getElementById('sharePreview');
        const includeFinalImage = document.getElementById('shareFinalImage').checked;
        
        console.log('å¼€å§‹ç”Ÿæˆåˆ†äº«å›¾ç‰‡');
        console.log('æ˜¯å¦åŒ…å«æˆå“å›¾ç‰‡:', includeFinalImage);
        console.log('é¢„è§ˆå†…å®¹ä¸­çš„å›¾ç‰‡æ•°é‡:', sharePreview.getElementsByTagName('img').length);
        
        // æ·»åŠ åŠ è½½æç¤º
        const loadingToast = document.createElement('div');
        loadingToast.className = 'position-fixed top-50 start-50 translate-middle bg-dark text-white p-3 rounded';
        loadingToast.style.zIndex = '9999';
        loadingToast.textContent = 'ğŸ“¸ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
        document.body.appendChild(loadingToast);

        // å¤åˆ¶æ‰€æœ‰å¿…è¦çš„æ ·å¼
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            /* Bootstrap æ ¸å¿ƒæ ·å¼ */
            .card {
                position: relative;
                display: flex;
                flex-direction: column;
                min-width: 0;
                word-wrap: break-word;
                background-color: #fff;
                background-clip: border-box;
                border: 1px solid rgba(0,0,0,.125);
                border-radius: 4px;
                margin-bottom: 1rem;
            }
            .card-body {
                flex: 1 1 auto;
                padding: 1rem;
            }
            .card-title {
                margin-bottom: 0.5rem;
                font-size: 1.25rem;
            }
            .card-text {
                margin-bottom: 0;
            }
            .table {
                width: 100%;
                margin-bottom: 1rem;
                color: #212529;
                border-collapse: collapse;
            }
            .table th,
            .table td {
                padding: 0.75rem;
                vertical-align: top;
                border-top: 1px solid #dee2e6;
            }
            .table thead th {
                vertical-align: bottom;
                border-bottom: 2px solid #dee2e6;
            }
            .text-muted {
                color: #6c757d !important;
            }
            .mb-2 { margin-bottom: 0.5rem !important; }
            .mb-3 { margin-bottom: 1rem !important; }
            .mb-4 { margin-bottom: 1.5rem !important; }
            .mt-4 { margin-top: 1.5rem !important; }
            .p-4 { padding: 1.5rem !important; }
            .pt-2 { padding-top: 0.5rem !important; }
            .text-center { text-align: center !important; }
            .border-top { border-top: 1px solid #dee2e6 !important; }
            .rounded { border-radius: 0.25rem !important; }
            .img-fluid { max-width: 100%; height: auto; }
            
            /* è‡ªå®šä¹‰æ ·å¼ */
            .ingredient-highlight {
                background-color: #e3f2fd;
                border-radius: 3px;
                padding: 2px 4px;
                font-weight: bold;
                color: #1976d2;
                display: inline-block;
                line-height: 1.2;
                margin: 0 2px;
            }
            h2 { font-size: 2rem; margin-bottom: 1rem; }
            h4 { font-size: 1.5rem; margin-bottom: 1rem; }
            small { font-size: 0.875rem; }
            .table-responsive { overflow-x: auto; }
            
            /* åˆ†äº«å›¾ç‰‡ç‰¹å®šæ ·å¼ */
            #sharePreview {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                color: #333;
                line-height: 1.5;
                max-width: 800px;
                margin: 0 auto;
                padding: 1rem !important;
            }
            #sharePreview .mb-4 {
                margin-bottom: 1rem !important;
            }
            #sharePreview h2 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            #sharePreview h4 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
                margin-top: 0.5rem;
            }
            #sharePreview .card {
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                margin-bottom: 0.5rem;
            }
            #sharePreview .card-body {
                padding: 0.5rem;
            }
            #sharePreview img {
                max-height: 250px;
                object-fit: cover;
                margin: 0.5rem auto;
                display: block;
            }
            #sharePreview .badge {
                font-size: 0.9rem;
                font-weight: normal;
            }
            #sharePreview p {
                margin-bottom: 0;
            }
            #sharePreview .watermark {
                font-size: 0.8rem;
                color: #6c757d;
                text-align: center;
                padding-top: 0.5rem;
                margin-top: 0.5rem;
                border-top: 1px solid #dee2e6;
            }
            #sharePreview .text-muted {
                font-size: 0.8rem;
            }
        `;
        
        // å…‹éš†é¢„è§ˆå†…å®¹å¹¶åº”ç”¨æ ·å¼
        html2canvas(sharePreview, {
            scale: 2,  // æé«˜æ¸…æ™°åº¦
            useCORS: includeFinalImage,  // åªåœ¨éœ€è¦åŠ è½½å›¾ç‰‡æ—¶å¯ç”¨è·¨åŸŸ
            backgroundColor: '#ffffff',  // è®¾ç½®ç™½è‰²èƒŒæ™¯
            scrollY: -window.scrollY,  // ä¿®å¤æ»šåŠ¨é—®é¢˜
            ignoreElements: (element) => {
                // å¦‚æœä¸åŒ…å«æˆå“å›¾ç‰‡ï¼Œå¿½ç•¥æ‰€æœ‰ img å…ƒç´ 
                return !includeFinalImage && element.tagName === 'IMG';
            },
            onclone: function(clonedDoc) {
                console.log('å…‹éš†é¢„è§ˆå†…å®¹');
                const clonedPreview = clonedDoc.getElementById('sharePreview');
                console.log('å…‹éš†åçš„å›¾ç‰‡æ•°é‡:', clonedPreview.getElementsByTagName('img').length);
                
                // æ·»åŠ æ ·å¼åˆ°å…‹éš†çš„æ–‡æ¡£
                clonedDoc.head.appendChild(styleSheet);
                
                // ç¡®ä¿å…‹éš†çš„å…ƒç´ æ ·å¼æ­£ç¡®
                clonedPreview.style.width = sharePreview.offsetWidth + 'px';
                clonedPreview.style.padding = '1rem';
                
                // è°ƒæ•´æ‰€æœ‰å¡ç‰‡çš„å†…è¾¹è·
                clonedPreview.querySelectorAll('.card-body').forEach(cardBody => {
                    cardBody.style.padding = '0.5rem';
                });
                
                // è°ƒæ•´æ‰€æœ‰æ ‡é¢˜çš„è¾¹è·
                clonedPreview.querySelectorAll('h4').forEach(h4 => {
                    h4.style.marginBottom = '0.5rem';
                    h4.style.marginTop = '0.5rem';
                });
                
                // è°ƒæ•´æ‰€æœ‰æ®µè½çš„è¾¹è·
                clonedPreview.querySelectorAll('p').forEach(p => {
                    p.style.marginBottom = '0';
                });
                
                // ç¡®ä¿æ‰€æœ‰å›¾ç‰‡éƒ½å·²åŠ è½½ï¼ˆåªåœ¨å‹¾é€‰äº†æˆå“å›¾ç‰‡æ—¶ï¼‰
                if (includeFinalImage) {
                    console.log('ç­‰å¾…å›¾ç‰‡åŠ è½½...');
                    const images = clonedPreview.getElementsByTagName('img');
                    return new Promise(resolve => {
                        if (images.length === 0) {
                            console.log('æ²¡æœ‰éœ€è¦åŠ è½½çš„å›¾ç‰‡');
                            resolve();
                        }
                        let loadedImages = 0;
                        for (let img of images) {
                            if (img.complete) {
                                loadedImages++;
                                console.log(`å›¾ç‰‡å·²åŠ è½½å®Œæˆ: ${loadedImages}/${images.length}`);
                                if (loadedImages === images.length) resolve();
                            } else {
                                img.onload = () => {
                                    loadedImages++;
                                    console.log(`å›¾ç‰‡åŠ è½½å®Œæˆ: ${loadedImages}/${images.length}`);
                                    if (loadedImages === images.length) resolve();
                                };
                                img.onerror = () => {
                                    loadedImages++;
                                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                                    if (loadedImages === images.length) resolve();
                                };
                            }
                        }
                    });
                } else {
                    console.log('ä¸éœ€è¦ç­‰å¾…å›¾ç‰‡åŠ è½½');
                }
            }
        }).then(canvas => {
            console.log('å›¾ç‰‡ç”Ÿæˆå®Œæˆ');
            // ç§»é™¤åŠ è½½æç¤º
            document.body.removeChild(loadingToast);

            // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
            const link = document.createElement('a');
            link.download = `èœè°±_${document.querySelector('h1').textContent.trim()}_${new Date().toLocaleDateString('zh-CN')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(error => {
            console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
            alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            document.body.removeChild(loadingToast);
        });
    };

    // æ·»åŠ è§†å›¾åˆ‡æ¢åŠŸèƒ½
    window.switchIngredientsView = function(view) {
        const compactView = document.getElementById('compactView');
        const tableView = document.getElementById('tableView');
        const [compactBtn, tableBtn] = document.querySelectorAll('.btn-group .btn');
        
        if (view === 'compact') {
            compactView.style.display = 'flex';
            tableView.style.display = 'none';
            compactBtn.classList.add('view-btn-active');
            compactBtn.classList.remove('active');
            tableBtn.classList.remove('view-btn-active', 'active');
            // ä¿å­˜ç”¨æˆ·åå¥½
            localStorage.setItem('ingredientsView', 'compact');
        } else {
            compactView.style.display = 'none';
            tableView.style.display = 'block';
            tableBtn.classList.add('view-btn-active');
            tableBtn.classList.remove('active');
            compactBtn.classList.remove('view-btn-active', 'active');
            // ä¿å­˜ç”¨æˆ·åå¥½
            localStorage.setItem('ingredientsView', 'table');
        }
    };

    // é¡µé¢åŠ è½½æ—¶æ¢å¤ç”¨æˆ·çš„è§†å›¾åå¥½
    document.addEventListener('DOMContentLoaded', function() {
        const savedView = localStorage.getItem('ingredientsView') || 'compact';
        switchIngredientsView(savedView);
    });

    // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ç´¢å¼•
    let currentImageIndex = 0;
    let allImages = [];

    // æ·»åŠ æŸ¥çœ‹åŸå›¾åŠŸèƒ½
    window.showOriginalImage = function(imageSrc) {
        const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
        // è·å–æ‰€æœ‰å›¾ç‰‡
        allImages = Array.from(document.querySelectorAll('.final-image-item img')).map(img => img.src);
        // æ‰¾åˆ°å½“å‰å›¾ç‰‡çš„ç´¢å¼•
        currentImageIndex = allImages.indexOf(imageSrc);
        document.getElementById('originalImage').src = imageSrc;
        modal.show();
    };

    // æ·»åŠ ç‚¹å‡»å…³é—­åŠŸèƒ½
    window.closeImageModal = function(event) {
        if (event.target.classList.contains('modal-body')) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('imageViewModal'));
            if (modal) modal.hide();
        }
    };

    // ä¸Šä¸€å¼ å›¾ç‰‡
    window.prevImage = function(event) {
        event.stopPropagation();
        if (currentImageIndex > 0) {
            currentImageIndex--;
            document.getElementById('originalImage').src = allImages[currentImageIndex];
        }
    };

    // ä¸‹ä¸€å¼ å›¾ç‰‡
    window.nextImage = function(event) {
        event.stopPropagation();
        if (currentImageIndex < allImages.length - 1) {
            currentImageIndex++;
            document.getElementById('originalImage').src = allImages[currentImageIndex];
        }
    };

    // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
    document.addEventListener('keydown', function(event) {
        const modal = document.getElementById('imageViewModal');
        if (modal.classList.contains('show')) {
            if (event.key === 'ArrowLeft') {
                prevImage(event);
            } else if (event.key === 'ArrowRight') {
                nextImage(event);
            } else if (event.key === 'Escape') {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) modalInstance.hide();
            }
        }
    });

    // åˆå§‹åŒ–æˆå“å›¾ç‰‡çš„æ‹–æ‹½æ’åº
    const finalImagesContainer = document.getElementById('finalImagesContainer');
    if (finalImagesContainer) {
        // åªåœ¨ç®¡ç†æ¨¡å¼ä¸‹å¯ç”¨æ’åº
        if (localStorage.getItem('isAdmin') === 'true') {
            new Sortable(finalImagesContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function() {
                    const newOrder = Array.from(finalImagesContainer.children).map((item, index) => ({
                        id: parseInt(item.dataset.id),
                        order: index
                    }));
                    
                    fetch(`/recipe/{{ recipe.id }}/final_images/reorder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(newOrder)
                    });
                }
            });
        }
    }
});
</script>

<style>
/* è¦†ç›–è¡¨æ ¼é»˜è®¤è¾¹æ¡†æ ·å¼ */
.table>:not(:first-child) {
    border-top: 1px solid rgb(222, 226, 230);
}

.final-images-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.final-image-item {
    cursor: move;
}

.final-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.sortable-ghost {
    opacity: 0.5;
}

/* ä¿®æ”¹å›¾ç‰‡æŸ¥çœ‹ç›¸å…³æ ·å¼ */
#imageViewModal .modal-content {
    background-color: transparent;
    border: none;
    box-shadow: none;
}

#imageViewModal .modal-dialog {
    max-width: 100%;
    margin: 0;
}

#imageViewModal .modal-body {
    padding: 0;
    background-color: rgba(0, 0, 0, 0.3);
    cursor: zoom-out;
}

#originalImage {
    max-height: 100vh;
    max-width: 100vw;
    object-fit: contain;
    cursor: default;
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
    z-index: 1050;
}

/* æ·»åŠ åˆ‡æ¢æŒ‰é’®æ ·å¼ */
.btn-prev, .btn-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.8);
    font-size: 2rem;
    padding: 1rem;
    cursor: pointer;
    transition: color 0.2s;
    z-index: 1050;
}

.btn-prev:hover, .btn-next:hover {
    color: white;
}

.btn-prev {
    left: 1rem;
}

.btn-next {
    right: 1rem;
}
</style>
{% endblock %} 