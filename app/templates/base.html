<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ config.SITE_NAME }}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- ç®¡ç†æ¨¡å¼ç™»å½•æ¨¡æ€çª—å£ -->
    <div class="modal fade" id="adminLoginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ‘¤ ç®¡ç†æ¨¡å¼ç™»å½•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="loginError" style="display: none;"></div>
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">ğŸ”‘ è¯·è¾“å…¥ç®¡ç†å¯†ç </label>
                        <input type="password" class="form-control" id="adminPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="handleLogin()">ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†æ¨¡å¼è®¾ç½®æ¨¡æ€çª—å£ -->
    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš™ï¸ ç®¡ç†è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="changePasswordError" style="display: none;"></div>
                    <div class="alert alert-success" id="changePasswordSuccess" style="display: none;"></div>
                    <form id="changeSiteNameForm" class="mb-4">
                        <div class="mb-3">
                            <label for="siteName" class="form-label">ç«™ç‚¹åç§°</label>
                            <input type="text" class="form-control" id="siteName" value="{{ config.SITE_NAME }}" required>
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100">
                            âœ¨ æ›´æ–°ç«™ç‚¹åç§°
                        </button>
                    </form>
                    <hr>
                    <form id="changePasswordForm" class="mb-4">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">æ–°å¯†ç </label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100">
                            ğŸ”„ ä¿®æ”¹å¯†ç 
                        </button>
                    </form>
                    <hr>
                    <div class="d-flex gap-2">
                        <button type="button" id="debugModeBtn" 
                                class="btn btn-outline-primary flex-grow-1" 
                                onclick="handleChangeDebug()"
                                title="Erudaå·¥å…·">
                            ğŸ”§ {% if config.ENABLE_ERUDA %}å…³é—­{% else %}å¼€å¯{% endif %}è°ƒè¯•
                        </button>
                        <button type="button" class="btn btn-outline-primary flex-grow-1" onclick="handleLogout()">
                            ğŸšª é€€å‡ºç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ç®¡ç†æŒ‰é’®æ ·å¼ */
        .admin-btn {
            padding: 4px;
            font-size: 1.1rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #bbb;
        }
        
        .admin-btn:hover {
            color: #999;
            background-color: #f8f9fa;
        }
        
        .admin-btn.btn-danger {
            color: #ff8a80;
        }
        
        .admin-btn.btn-danger:hover {
            background-color: #fff5f5;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ£€æŸ¥åç«¯ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch('/test_login_status');
                const data = await response.json();
                if (data.logged_in) {
                    localStorage.setItem('isAdmin', 'true');
                } else {
                    localStorage.removeItem('isAdmin');
                }
                updateAdminElements();
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            updateAdminButton();
        });

        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const password = document.getElementById('adminPassword').value;
            const errorAlert = document.getElementById('loginError');
            const loginModal = document.getElementById('adminLoginModal');
            
            errorAlert.style.display = 'none';
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('adminPassword').value = '';
                    bootstrap.Modal.getInstance(loginModal).hide();
                    // é‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€
                    checkLoginStatus();
                } else {
                    errorAlert.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    errorAlert.style.display = 'block';
                }
            } catch (error) {
                errorAlert.textContent = 'ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                errorAlert.style.display = 'block';
            }
        }

        // å¤„ç†é€€å‡ºç™»å½•
        async function handleLogout() {
            try {
                const response = await fetch('/logout');
                if (response.ok) {
                    localStorage.removeItem('isAdmin');
                    const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminModal'));
                    if (adminModal) {
                        adminModal.hide();
                    }
                    // è§¦å‘çŠ¶æ€å˜åŒ–äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('adminModeChanged', {
                        detail: { isAdmin: false }
                    }));
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateAdminButton();
                    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ‰€æœ‰çŠ¶æ€
                    window.location.reload();
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç®¡ç†å…ƒç´ æ˜¾ç¤ºçŠ¶æ€
        function updateAdminElements() {
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(element => {
                element.style.display = localStorage.getItem('isAdmin') === 'true' ? '' : 'none';
            });
            
            // æ›´æ–°ç®¡ç†æŒ‰é’®çŠ¶æ€
            const adminBtn = document.getElementById('adminModeBtn');
            if (adminBtn) {
                if (localStorage.getItem('isAdmin') === 'true') {
                    adminBtn.classList.add('btn-danger');
                    adminBtn.classList.remove('btn-outline-primary');
                } else {
                    adminBtn.classList.remove('btn-danger');
                }
            }
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥å…¶ä»–é¡µé¢
            const event = new CustomEvent('adminModeChanged', { detail: { isAdmin: localStorage.getItem('isAdmin') === 'true' } });
            window.dispatchEvent(event);
        }

        // åˆ‡æ¢ç®¡ç†æ¨¡å¼
        function toggleAdminMode() {
            if (localStorage.getItem('isAdmin') === 'true') {
                // å¦‚æœå·²ç»æ˜¯ç®¡ç†æ¨¡å¼ï¼Œåˆ™é€€å‡º
                localStorage.removeItem('isAdmin');
                updateAdminElements();
                alert('å·²é€€å‡ºç®¡ç†æ¨¡å¼');
            } else {
                // å¦‚æœä¸æ˜¯ç®¡ç†æ¨¡å¼ï¼Œåˆ™æ˜¾ç¤ºç™»å½•çª—å£
                const modal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
                modal.show();
            }
        }

        // æ›´æ–°ç®¡ç†æŒ‰é’®çŠ¶æ€
        function updateAdminButton() {
            const adminBtn = document.getElementById('adminModeBtn');
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (adminBtn) {
                adminBtn.className = `btn admin-btn ${isAdmin ? 'btn-danger' : ''}`;
            }
        }

        // ä¿®æ”¹å¯†ç å¤„ç†å‡½æ•°
        async function handleChangePassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const errorAlert = document.getElementById('changePasswordError');
            const successAlert = document.getElementById('changePasswordSuccess');
            
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
            
            try {
                const response = await fetch('/admin/change_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_password: newPassword
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successAlert.textContent = 'å¯†ç ä¿®æ”¹æˆåŠŸ';
                    successAlert.style.display = 'block';
                    document.getElementById('changePasswordForm').reset();
                } else {
                    errorAlert.textContent = data.error || 'å¯†ç ä¿®æ”¹å¤±è´¥';
                    errorAlert.style.display = 'block';
                }
            } catch (error) {
                errorAlert.textContent = 'ä¿®æ”¹å¯†ç è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                errorAlert.style.display = 'block';
            }
        }

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

        // ç›‘å¬æ¨¡æ€çª—å£å…³é—­äº‹ä»¶ï¼Œæ¸…é™¤æç¤ºå’Œè¾“å…¥
        document.getElementById('adminModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('changePasswordError').style.display = 'none';
            document.getElementById('changePasswordSuccess').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
        });

        // ä¿®æ”¹ç«™ç‚¹åç§°å¤„ç†å‡½æ•°
        async function handleChangeSiteName(event) {
            event.preventDefault();
            
            const siteName = document.getElementById('siteName').value;
            const errorAlert = document.getElementById('changePasswordError');
            const successAlert = document.getElementById('changePasswordSuccess');
            
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
            
            try {
                const response = await fetch('/admin/change_site_name', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        site_name: siteName
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successAlert.textContent = 'ç«™ç‚¹åç§°ä¿®æ”¹æˆåŠŸï¼Œåˆ·æ–°é¡µé¢åç”Ÿæ•ˆ';
                    successAlert.style.display = 'block';
                } else {
                    errorAlert.textContent = data.error || 'ç«™ç‚¹åç§°ä¿®æ”¹å¤±è´¥';
                    errorAlert.style.display = 'block';
                }
            } catch (error) {
                errorAlert.textContent = 'ä¿®æ”¹ç«™ç‚¹åç§°è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                errorAlert.style.display = 'block';
            }
        }

        // ç»‘å®šç«™ç‚¹åç§°è¡¨å•æäº¤äº‹ä»¶
        document.getElementById('changeSiteNameForm').addEventListener('submit', handleChangeSiteName);

        // ä¿®æ”¹è°ƒè¯•æ¨¡å¼å¤„ç†å‡½æ•°
        async function handleChangeDebug() {
            const debugModeBtn = document.getElementById('debugModeBtn');
            const currentDebugMode = debugModeBtn.textContent.includes('å…³é—­');
            const errorAlert = document.getElementById('changePasswordError');
            const successAlert = document.getElementById('changePasswordSuccess');
            
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
            
            try {
                const response = await fetch('/admin/change_debug_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enable_eruda: !currentDebugMode
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    debugModeBtn.textContent = currentDebugMode ? 'ğŸ”§ å¼€å¯è°ƒè¯•' : 'ğŸ”§ å…³é—­è°ƒè¯•';
                    successAlert.textContent = 'ErudaçŠ¶æ€å·²æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢åç”Ÿæ•ˆ';
                    successAlert.style.display = 'block';
                } else {
                    errorAlert.textContent = data.error || 'è°ƒè¯•å·¥å…·è®¾ç½®å¤±è´¥';
                    errorAlert.style.display = 'block';
                }
            } catch (error) {
                errorAlert.textContent = 'ä¿®æ”¹è°ƒè¯•å·¥å…·è®¾ç½®è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                errorAlert.style.display = 'block';
            }
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html> 