<!-- ç»Ÿä¸€çš„èœè°±ç¼–è¾‘æ¨¡æ€çª—å£ -->
<div class="modal fade" id="recipeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recipeModalTitle">âœ¨ åˆ›å»ºæ–°èœè°±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- æ·»åŠ  Sortable.js -->
                <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
                <style>
                    .sortable-ghost {
                        opacity: 0.4;
                        background-color: #f8f9fa;
                    }
                    .sortable-fallback {
                        opacity: 0.8;
                        transform: scale(0.95);
                        background-color: white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                        border-radius: 4px;
                        pointer-events: none;
                        z-index: 1000;
                    }
                    .sortable-drag {
                        opacity: 0;
                    }
                    .drag-handle:hover {
                        color: #0d6efd;
                    }
                    .step-item, .note-item {
                        transition: background-color 0.2s ease;
                        border-left: 4px solid #ffb6c1;
                        padding-left: 12px;
                    }
                    .step-item:hover, .note-item:hover {
                        background-color: #f8f9fa;
                    }
                    .step-item textarea {
                        cursor: text;
                    }
                    .step-item button {
                        cursor: pointer;
                    }
                    .step-header, .note-header {
                        cursor: move;
                        user-select: none;
                    }
                    .step-header:hover {
                        background-color: #f8f9fa;
                    }
                    .step-content {
                        padding: 8px;
                    }
                    .ingredient-item {
                        display: inline-flex;
                        margin: 0.25rem;
                        margin-bottom: 0.5rem;
                        border: 1px solid #ff9999;
                        border-radius: 20px;
                        overflow: hidden;
                        background-color: white;
                        transition: all 0.2s ease;
                    }
                    .ingredient-item input {
                        border: none;
                        background: transparent;
                        font-size: 0.875rem;
                        line-height: 1.5;
                        color: #ff9999;
                        min-width: 6ch;
                        padding: 0.25rem;
                    }
                    .ingredient-item input:first-child {
                        border-right: 1px solid #ff9999;
                        padding-left: 0.5rem;
                    }
                    .ingredient-item input.ingredient-amount {
                        min-width: 6ch;
                    }
                    .ingredient-item input.ingredient-note {
                        border-right: 1px solid #ff9999;
                    }
                    .ingredient-item input:focus {
                        outline: none;
                        background-color: transparent;
                    }
                    .ingredient-item:hover {
                        background-color: #ff9999;
                    }
                    .ingredient-item:hover input {
                        color: white;
                    }
                    .ingredient-item:hover input::placeholder {
                        color: rgba(255, 255, 255, 0.8);
                    }
                    .ingredient-item input::placeholder {
                        color: rgba(255, 153, 153, 0.8);
                    }
                    .ingredient-item button.remove-ingredient {
                        border: none;
                        background: transparent;
                        color: #ff9999;
                        padding: 0 0.5rem;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .ingredient-item:hover button.remove-ingredient {
                        color: white;
                    }
                    .common-ingredient-item {
                        display: inline-flex;
                        margin: 0.25rem;
                        border: 1px solid #ff9999;
                        border-radius: 20px;
                        overflow: hidden;
                        background-color: white;
                        transition: all 0.2s ease;
                    }
                    .common-ingredient-item input {
                        border: none;
                        background: transparent;
                        font-size: 0.875rem;
                        line-height: 1.5;
                        color: #ff9999;
                        min-width: 6ch;
                        padding: 0.25rem;
                    }
                    .common-ingredient-item input:first-child {
                        border-right: 1px solid #ff9999;
                        min-width: 8ch;
                        padding-left: 0.5rem;
                    }
                    .common-ingredient-item input:last-child {
                        padding-right: 0.5rem;
                        min-width: 6ch;
                    }
                    .common-ingredient-item:hover {
                        background-color: #ff9999;
                    }
                    .common-ingredient-item:hover input {
                        color: white;
                    }
                    .common-ingredient-item:hover input::placeholder {
                        color: rgba(255, 255, 255, 0.8);
                    }
                    .common-ingredient-item input::placeholder {
                        color: rgba(255, 153, 153, 0.8);
                    }
                    .common-ingredient-item input:focus {
                        outline: none;
                        background-color: transparent;
                    }
                    #commonIngredientsList button {
                        color: #ff9999;
                        border-color: #ff9999;
                        border-radius: 20px;
                        transition: all 0.2s ease;
                    }
                    #commonIngredientsList button:hover {
                        background-color: #ff9999;
                        color: white;
                    }
                    .common-ingredients .btn {
                        color: #ff9999;
                        border-color: #ff9999;
                        border-radius: 20px;
                        transition: all 0.2s ease;
                    }
                    .common-ingredients .btn:hover {
                        background-color: #ff9999;
                        color: white;
                    }
                    #ingredientsList {
                        padding-bottom: 0.5rem;
                    }
                    .final-images-container {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                        gap: 1rem;
                    }
                    .final-image-item {
                        cursor: move;
                    }
                    .final-image-item img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }
                    .upload-progress {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        height: 4px;
                        background-color: rgba(255, 255, 255, 0.5);
                        border-radius: 0 0 4px 4px;
                    }
                    .upload-progress-bar {
                        height: 100%;
                        background-color: #ff9999;
                        width: 0;
                        transition: width 0.2s;
                        border-radius: 0 0 4px 4px;
                    }
                    .upload-status {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.7);
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                    }
                    .delete-final-image {
                        opacity: 0;
                        transition: opacity 0.2s;
                        z-index: 10;
                        pointer-events: auto;
                    }
                    .final-image-item:hover .delete-final-image {
                        opacity: 1;
                    }
                    /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé»˜è®¤æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
                    @media (max-width: 768px) {
                        .delete-final-image {
                            opacity: 1;
                            z-index: 100;
                        }
                    }
                </style>
                <form id="recipeForm" enctype="multipart/form-data">
                    <input type="hidden" id="recipe-id" name="recipe_id">
                    <div class="mb-3">
                        <label for="recipe-name" class="form-label">ğŸ·ï¸ èœå</label>
                        <input type="text" class="form-control" id="recipe-name" name="name" required>
                        <div class="invalid-feedback" style="display: none;">è¯·è¾“å…¥èœå</div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">ğŸ“ æè¿°</label>
                        <textarea class="form-control auto-expand" id="description" name="description" rows="3" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                        <div class="video-preview mt-2"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ğŸ¥˜ é£Ÿæå‡†å¤‡</label>
                        <div class="common-ingredients mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">ğŸ” å¸¸ç”¨é£Ÿæå¿«é€Ÿé€‰æ‹©</label>
                                <button type="button" class="btn btn-sm" id="manageCommonIngredients">
                                    âš™ï¸ ç®¡ç†
                                </button>
                            </div>
                            <div id="commonIngredientsList" class="common-ingredients-list"></div>
                        </div>
                        <div id="ingredientsList"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addIngredient">
                            â• æ·»åŠ é£Ÿæ
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ğŸ“ åˆ¶ä½œæ­¥éª¤</label>
                        <div id="stepsList"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addStep">
                            â• æ·»åŠ æ­¥éª¤
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ğŸ“’ æ”¹è¿›ç¬”è®°</label>
                        <div id="notesList"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addNote">
                            â• æ·»åŠ ç¬”è®°
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ğŸ“¸ æˆå“å›¾ç‰‡</label>
                        <div id="finalImagesList" class="final-images-container mb-2"></div>
                        <input type="file" class="form-control" id="recipe-final-images" name="final_images[]" accept="image/*" multiple onchange="handleImageUpload(event)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="deleteRecipe" style="display: none;">ğŸ—‘ï¸ åˆ é™¤èœè°±</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveRecipe">âœ¨ ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿä¸€çš„JavaScriptä»£ç  -->
<script>
// ä»æœåŠ¡å™¨è·å–è°ƒè¯•é…ç½®
const DEBUG_CONFIG = JSON.parse('{{ debug_config|tojson|safe }}');

// è‡ªå®šä¹‰æ—¥å¿—å‡½æ•°
function debugLog(...args) {
    console.log(...args);
}

function debugError(...args) {
    console.error(...args);
}

// åˆå§‹åŒ–ç§»åŠ¨ç«¯è°ƒè¯•å·¥å…·
if (DEBUG_CONFIG.ENABLE_ERUDA) {
    (function () {
        var script = document.createElement('script');
        script.src = "//cdn.jsdelivr.net/npm/eruda";
        document.body.appendChild(script);
        script.onload = function () {
            eruda.init();
        };
    })();
}

document.addEventListener('DOMContentLoaded', function() {
    const recipeModal = document.getElementById('recipeModal');
    const modal = new bootstrap.Modal(recipeModal);
    
    // åˆå§‹åŒ–æ¨¡æ€çª—å£
    function initializeModal(mode = 'create', recipeData = null) {
        const form = document.getElementById('recipeForm');
        const modalTitle = document.getElementById('recipeModalTitle');
        const deleteButton = document.getElementById('deleteRecipe');
        const saveButton = document.getElementById('saveRecipe');
        const manageButton = document.getElementById('manageCommonIngredients');
        
        // é‡ç½®ç®¡ç†æŒ‰é’®çŠ¶æ€
        manageButton.textContent = 'âš™ï¸ ç®¡ç†';
        manageButton.style.backgroundColor = '';
        manageButton.style.color = '#ff9999';
        manageButton.setAttribute('data-manage-mode', 'false');
        
        // é‡ç½®è¡¨å•
        form.reset();
        document.getElementById('ingredientsList').innerHTML = '';
        document.getElementById('stepsList').innerHTML = '';
        document.getElementById('notesList').innerHTML = '';
        document.getElementById('finalImagesList').innerHTML = '';
        
        // æ¸…é™¤è§†é¢‘é¢„è§ˆ
        const videoPreview = document.querySelector('.video-preview');
        if (videoPreview) {
            videoPreview.innerHTML = '';
        }
        
        // åˆå§‹åŒ–å¸¸ç”¨é£Ÿæ
        initializeCommonIngredients();
        
        if (mode === 'create') {
            modalTitle.textContent = 'âœ¨ åˆ›å»ºæ–°èœè°±';
            deleteButton.style.display = 'none';
            saveButton.textContent = 'âœ¨ åˆ›å»ºèœè°±';
            document.getElementById('recipe-id').value = '';
        } else {
            modalTitle.textContent = 'âœï¸ ç¼–è¾‘èœè°±';
            deleteButton.style.display = 'block';
            saveButton.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            
            if (recipeData) {
                loadRecipeData(recipeData);
            }
        }
        
        // æ·»åŠ åˆå§‹çš„é£Ÿæã€æ­¥éª¤å’Œç¬”è®°
        if (mode === 'create') {
            addIngredientWithValues('ingredientsList');
            addStep();
            addNote();
        }

        // ä¸ºæè¿°æ–‡æœ¬æ¡†æ·»åŠ è§†é¢‘æ£€æµ‹
        const descriptionTextarea = document.getElementById('description');
        if (descriptionTextarea) {
            setupVideoDetection(descriptionTextarea);
        }
        
        modal.show();
    }
    
    // åŠ è½½èœè°±æ•°æ®
    function loadRecipeData(recipe) {
        document.getElementById('recipe-id').value = recipe.id;
        document.getElementById('recipe-name').value = recipe.name;
        document.getElementById('description').value = recipe.description;
        
        // åŠ è½½é£Ÿæ
        recipe.ingredients.forEach(ingredient => {
            addIngredientWithValues('ingredientsList', ingredient.name, ingredient.amount, ingredient.note);
        });
        
        // åŠ è½½æ­¥éª¤
        recipe.steps.forEach(step => {
            addStep(step.description);
        });
        
        // åŠ è½½ç¬”è®°
        if (recipe.notes && recipe.notes.length > 0) {
            recipe.notes.forEach(note => {
                const created_at = note.created_at ? new Date(note.created_at).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';
                const updated_at = note.updated_at ? new Date(note.updated_at).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';
                addNote(note.content, created_at, updated_at, note.id);
            });
        }
        
        // åŠ è½½æˆå“å›¾ç‰‡
        const finalImagesList = document.getElementById('finalImagesList');
        finalImagesList.innerHTML = '';
        if (recipe.final_images && recipe.final_images.length > 0) {
            recipe.final_images.forEach(image => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'final-image-item';
                imageDiv.setAttribute('data-id', image.id);
                imageDiv.innerHTML = `
                    <div class="position-relative">
                        <img src="/static/${image.path}" class="img-fluid rounded" alt="æˆå“å›¾ç‰‡">
                        <button type="button" class="btn btn-sm position-absolute top-0 end-0 m-2 delete-final-image" 
                                style="background: rgba(255, 255, 255, 0.8); border-radius: 50%; width: 30px; height: 30px; padding: 0; z-index: 100;">
                            âŒ
                        </button>
                    </div>
                `;
                finalImagesList.appendChild(imageDiv);
            });
        }
        
        // ä¿®æ”¹ Sortable åˆå§‹åŒ–ï¼Œæ·»åŠ å›¾ç‰‡æ’åºåŠŸèƒ½
        const finalImagesContainer = document.getElementById('finalImagesList');
        new Sortable(finalImagesContainer, {
            animation: 150,
            filter: '.delete-final-image',  // æ’é™¤åˆ é™¤æŒ‰é’®ä¸å‚ä¸æ‹–åŠ¨
            preventOnFilter: true,  // é˜»æ­¢åœ¨è¿‡æ»¤å…ƒç´ ä¸Šçš„é»˜è®¤äº‹ä»¶
        });
    }
    
    // æ·»åŠ é£Ÿæ
    function addIngredientWithValues(containerId, name = '', amount = '', note = '') {
        const template = `
            <div class="ingredient-item">
                <input type="text" class="ingredient-name" name="ingredients[]" value="${name}" placeholder="é£Ÿæåç§°">
                <input type="text" class="ingredient-amount" name="amounts[]" value="${amount}" placeholder="ç”¨é‡">
                <input type="text" class="ingredient-note" name="ingredient_notes[]" value="${note}" placeholder="å¤‡æ³¨">
                <button type="button" class="remove-ingredient">âŒ</button>
            </div>
        `;
        document.getElementById(containerId).insertAdjacentHTML('beforeend', template);
        
        // ä¸ºæ–°æ·»åŠ çš„é£Ÿæè¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
        const newIngredient = document.getElementById(containerId).lastElementChild;
        const inputs = newIngredient.querySelectorAll('input');
        inputs.forEach(input => {
            // è°ƒæ•´è¾“å…¥æ¡†å®½åº¦
            adjustInputWidth(input);
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶ä»¥è°ƒæ•´å®½åº¦
            input.addEventListener('input', () => adjustInputWidth(input));
            
            // ç›‘å¬å›è½¦é”®
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // é˜»æ­¢è¡¨å•æäº¤
                    addIngredientWithValues('ingredientsList');
                    // èšç„¦åˆ°æ–°æ·»åŠ çš„é£Ÿæåç§°è¾“å…¥æ¡†
                    const lastIngredient = document.getElementById('ingredientsList').lastElementChild;
                    const nameInput = lastIngredient.querySelector('.ingredient-name');
                    nameInput.focus();
                }
            });
        });
    }
    
    // ä¿®æ”¹æ­¥éª¤æ¨¡æ¿
    function addStep(description = '') {
        const template = `
            <div class="step-item">
                <div class="step-header">
                    <label class="form-label">âœ¨ æ­¥éª¤ ${document.querySelectorAll('.step-item').length + 1}</label>
                    <button type="button" class="remove-step" style="border: none; background: none; padding: 2px 6px;">âŒ</button>
                </div>
                <textarea class="form-control auto-expand" name="steps[]" rows="2" placeholder="è¾“å…¥æ­¥éª¤æè¿°">${description}</textarea>
            </div>
        `;
        document.getElementById('stepsList').insertAdjacentHTML('beforeend', template);
        
        // ä¸ºæ–°æ·»åŠ çš„æ­¥éª¤ç»‘å®šè‡ªåŠ¨æ‰©å±•äº‹ä»¶
        const newStep = document.getElementById('stepsList').lastElementChild;
        const textarea = newStep.querySelector('textarea');
        setupAutoExpand(textarea);
    }
    
    // ä¿®æ”¹ç¬”è®°æ¨¡æ¿
    function addNote(content = '', created_at = '', updated_at = '', note_id = '') {
        const template = `
            <div class="note-item mb-3">
                <div class="note-header d-flex justify-content-between align-items-center mb-2 position-relative">
                    <div>
                        <label class="form-label mb-0">ğŸ“ ç¬”è®°</label>
                        ${created_at ? `
                            <small class="text-muted ms-2">
                                åˆ›å»ºäº ${created_at}
                            </small>
                        ` : ''}
                    </div>
                    <button type="button" class="btn btn-sm remove-note position-absolute end-0" 
                        style="border: none; padding: 2px 6px; font-size: 12px;">
                        âŒ
                    </button>
                </div>
                <textarea class="form-control auto-expand" name="notes[]" rows="2" placeholder="è®°å½•ä½ çš„æ”¹è¿›å»ºè®®...">${content}</textarea>
                <input type="hidden" name="note_ids[]" value="${note_id}">
            </div>
        `;
        document.getElementById('notesList').insertAdjacentHTML('beforeend', template);
        
        // ä¸ºæ–°æ·»åŠ çš„ç¬”è®°ç»‘å®šè‡ªåŠ¨æ‰©å±•äº‹ä»¶
        const newNote = document.getElementById('notesList').lastElementChild;
        const textarea = newNote.querySelector('textarea');
        setupAutoExpand(textarea);
    }
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('addIngredient').addEventListener('click', () => addIngredientWithValues('ingredientsList'));
    document.getElementById('addStep').addEventListener('click', () => addStep());
    document.getElementById('addNote').addEventListener('click', () => addNote());
    
    // åˆ é™¤äº‹ä»¶å§”æ‰˜
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-ingredient')) {
            e.target.closest('.ingredient-item').remove();
        } else if (e.target.classList.contains('remove-step')) {
            e.target.closest('.step-item').remove();
            updateStepNumbers();
        } else if (e.target.classList.contains('remove-note')) {
            e.target.closest('.note-item').remove();
        }
    });
    
    // ä¿®æ”¹ Sortable åˆå§‹åŒ–
    const stepsContainer = document.getElementById('stepsList');
    new Sortable(stepsContainer, {
        animation: 150,
        handle: '.step-header',  // åªèƒ½é€šè¿‡å¤´éƒ¨åŒºåŸŸæ‹–åŠ¨
        onEnd: function() {
            updateStepNumbers();
        }
    });
    
    // æ›´æ–°æ­¥éª¤ç¼–å·
    function updateStepNumbers() {
        document.querySelectorAll('#stepsList .step-item').forEach((item, index) => {
            const label = item.querySelector('.form-label');
            if (label) {
                label.textContent = `âœ¨ æ­¥éª¤ ${index + 1}`;
            }
        });
    }
    
    // æ·»åŠ ä¸´æ—¶å›¾ç‰‡å­˜å‚¨æ•°ç»„
    let tempImages = [];

    // ä¿®æ”¹å›¾ç‰‡ä¸Šä¼ å¤„ç†å‡½æ•°
    window.handleImageUpload = function(event) {
        const files = event.target.files;
        const recipeId = document.getElementById('recipe-id').value;
        
        Array.from(files).forEach(file => {
            // åˆ›å»ºä¸´æ—¶URL
            const tempUrl = URL.createObjectURL(file);
            
            if (recipeId) {
                // å¦‚æœæœ‰recipe_idï¼Œç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('image', file);
                
                // åˆ›å»ºå¸¦æœ‰è¿›åº¦æ¡çš„é¢„è§ˆå…ƒç´ 
                const imageDiv = document.createElement('div');
                imageDiv.className = 'final-image-item';
                imageDiv.innerHTML = `
                    <div class="position-relative">
                        <img src="${tempUrl}" class="img-fluid rounded" alt="æˆå“å›¾ç‰‡">
                        <div class="upload-progress">
                            <div class="upload-progress-bar"></div>
                        </div>
                        <div class="upload-status">å‡†å¤‡ä¸Šä¼ ...</div>
                    </div>
                `;
                document.getElementById('finalImagesList').appendChild(imageDiv);

                const progressBar = imageDiv.querySelector('.upload-progress-bar');
                const statusText = imageDiv.querySelector('.upload-status');
                
                // ä½¿ç”¨ XMLHttpRequest æ¥è·å–ä¸Šä¼ è¿›åº¦
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `/recipe/${recipeId}/final_image/add`, true);
                
                // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
                xhr.timeout = 300000;
                
                // æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
                debugLog('å¼€å§‹ä¸Šä¼ å›¾ç‰‡:', file.name, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
                
                // æ·»åŠ çŠ¶æ€ç å¤„ç†
                xhr.onreadystatechange = function() {
                    debugLog('è¯·æ±‚çŠ¶æ€å˜åŒ–:', xhr.readyState, xhr.status);
                };
                
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        statusText.textContent = Math.round(percentComplete) + '%';
                        debugLog('ä¸Šä¼ è¿›åº¦:', Math.round(percentComplete) + '%',
                                  'å·²ä¸Šä¼ :', (e.loaded / 1024 / 1024).toFixed(2) + 'MB',
                                  'æ€»å¤§å°:', (e.total / 1024 / 1024).toFixed(2) + 'MB');
                    }
                };
                
                xhr.onload = function() {
                    debugLog('ä¸Šä¼ å®Œæˆï¼ŒçŠ¶æ€ç :', xhr.status);
                    debugLog('å“åº”å¤´:', xhr.getAllResponseHeaders());
                    
                    if (xhr.status === 502) {
                        debugError('æœåŠ¡å™¨ç½‘å…³é”™è¯¯ (502)');
                        statusText.textContent = 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·é‡è¯•';
                        statusText.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                        setTimeout(() => imageDiv.remove(), 2000);
                        return;
                    }
                    
                    try {
                        // æ£€æŸ¥å“åº”ç±»å‹
                        const contentType = xhr.getResponseHeader('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”');
                        }
                        
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status === 200 && response.success) {
                            debugLog('ä¸Šä¼ æˆåŠŸï¼Œå›¾ç‰‡ID:', response.image.id);
                            imageDiv.setAttribute('data-id', response.image.id);
                            imageDiv.innerHTML = `
                                <div class="position-relative">
                                    <img src="/static/${response.image.path}" class="img-fluid rounded" alt="æˆå“å›¾ç‰‡">
                                    <button type="button" class="btn btn-sm position-absolute top-0 end-0 m-2 delete-final-image" 
                                            style="background: rgba(255, 255, 255, 0.8); border-radius: 50%; width: 30px; height: 30px; padding: 0; z-index: 100;">
                                        âŒ
                                    </button>
                                </div>
                            `;
                        } else {
                            throw new Error(response.error || 'ä¸Šä¼ å¤±è´¥');
                        }
                    } catch (e) {
                        console.error('å¤„ç†å“åº”å¤±è´¥:', e);
                        statusText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                        statusText.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                        setTimeout(() => imageDiv.remove(), 2000);
                    }
                };

                xhr.onerror = function(e) {
                    debugError('ä¸Šä¼ é”™è¯¯:', e);
                    statusText.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                    statusText.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                    setTimeout(() => imageDiv.remove(), 2000);
                };

                xhr.ontimeout = function() {
                    debugError('ä¸Šä¼ è¶…æ—¶');
                    statusText.textContent = 'ä¸Šä¼ è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    statusText.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                    setTimeout(() => imageDiv.remove(), 2000);
                };
                
                try {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    const maxSize = 16 * 1024 * 1024; // 16MB
                    if (file.size > maxSize) {
                        throw new Error('æ–‡ä»¶å¤§å°è¶…è¿‡16MBé™åˆ¶');
                    }
                    
                    xhr.send(formData);
                    debugLog('å·²å‘é€ä¸Šä¼ è¯·æ±‚');
                } catch (e) {
                    console.error('å‘é€è¯·æ±‚å¤±è´¥:', e);
                    statusText.textContent = e.message || 'å‘é€è¯·æ±‚å¤±è´¥';
                    statusText.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                    setTimeout(() => imageDiv.remove(), 2000);
                }
            } else {
                // å¦‚æœæ²¡æœ‰recipe_idï¼Œä¿å­˜åˆ°ä¸´æ—¶æ•°ç»„
                tempImages.push(file);
                appendImageToList(null, tempUrl, true);
            }
        });
        
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤ä¸Šä¼ ç›¸åŒçš„æ–‡ä»¶
        event.target.value = '';
    };

    // æ·»åŠ å›¾ç‰‡åˆ°åˆ—è¡¨çš„è¾…åŠ©å‡½æ•°
    function appendImageToList(id, url, isTemp) {
        const imageDiv = document.createElement('div');
        imageDiv.className = 'final-image-item';
        if (id) imageDiv.setAttribute('data-id', id);
        if (isTemp) imageDiv.setAttribute('data-temp', 'true');
        
        imageDiv.innerHTML = `
            <div class="position-relative">
                <img src="${url}" class="img-fluid rounded" alt="æˆå“å›¾ç‰‡">
                <button type="button" class="btn btn-sm position-absolute top-0 end-0 m-2 delete-final-image" 
                        style="background: rgba(255, 255, 255, 0.8); border-radius: 50%; width: 30px; height: 30px; padding: 0; z-index: 100;">
                    âŒ
                </button>
            </div>
        `;
        document.getElementById('finalImagesList').appendChild(imageDiv);
    }

    // ä¿®æ”¹ä¿å­˜èœè°±çš„ä»£ç 
    document.getElementById('saveRecipe').addEventListener('click', function() {
        const form = document.getElementById('recipeForm');
        const formData = new FormData(form);
        const recipeId = document.getElementById('recipe-id').value;
        const nameInput = document.getElementById('recipe-name');
        const nameError = nameInput.nextElementSibling;
        
        // éªŒè¯èœå
        if (!nameInput.value.trim()) {
            nameInput.classList.add('is-invalid');
            nameError.style.display = 'block';
            nameInput.focus();
            return;
        }

        // æ·»åŠ ä¸´æ—¶å›¾ç‰‡åˆ°formData
        tempImages.forEach(file => {
            formData.append('final_images[]', file);
        });
        
        const url = recipeId ? `/recipe/${recipeId}/edit` : '/recipe/new';
        
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ¸…ç©ºä¸´æ—¶å›¾ç‰‡æ•°ç»„
                tempImages = [];
                location.reload();
            } else {
                nameInput.classList.add('is-invalid');
                nameError.textContent = data.error || 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰€æœ‰å¿…å¡«é¡¹';
                nameError.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('ä¿å­˜èœè°±æ—¶å‘ç”Ÿé”™è¯¯:', error);
            nameInput.classList.add('is-invalid');
            nameError.textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚';
            nameError.style.display = 'block';
        });
    });

    // ä¿®æ”¹åˆ é™¤å›¾ç‰‡çš„å¤„ç†
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-final-image')) {
            const imageItem = e.target.closest('.final-image-item');
            if (imageItem.hasAttribute('data-temp')) {
                // å¦‚æœæ˜¯ä¸´æ—¶å›¾ç‰‡ï¼Œä»ä¸´æ—¶æ•°ç»„ä¸­åˆ é™¤
                const imgSrc = imageItem.querySelector('img').src;
                const index = tempImages.findIndex(file => URL.createObjectURL(file) === imgSrc);
                if (index > -1) {
                    URL.revokeObjectURL(imgSrc); // é‡Šæ”¾URL
                    tempImages.splice(index, 1);
                }
                imageItem.remove();
            } else if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                const recipeId = document.getElementById('recipe-id').value;
                const imageId = imageItem.getAttribute('data-id');
                fetch(`/recipe/${recipeId}/final_image/${imageId}/delete`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        imageItem.remove();
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        }
    });

    // ä¿®æ”¹æ¨¡æ€çª—å£å…³é—­äº‹ä»¶å¤„ç†
    document.getElementById('recipeModal').addEventListener('hide.bs.modal', function() {
        const manageButton = document.getElementById('manageCommonIngredients');
        // é‡ç½®ç®¡ç†æŒ‰é’®çŠ¶æ€
        manageButton.textContent = 'âš™ï¸ ç®¡ç†';
        manageButton.style.backgroundColor = '';
        manageButton.style.color = '#ff9999';
        manageButton.setAttribute('data-manage-mode', 'false');
        // é‡æ–°åˆå§‹åŒ–å¸¸ç”¨é£Ÿæåˆ—è¡¨
        initializeCommonIngredients(false);
        // æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨
        document.getElementById('finalImagesList').innerHTML = '';
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
        document.getElementById('recipe-final-images').value = '';
        // æ¸…ç©ºä¸´æ—¶å›¾ç‰‡æ•°ç»„å’Œé‡Šæ”¾URL
        tempImages.forEach(file => {
            URL.revokeObjectURL(URL.createObjectURL(file));
        });
        tempImages = [];
    });

    // æ·»åŠ åˆ é™¤èœè°±çš„äº‹ä»¶å¤„ç†
    document.getElementById('deleteRecipe').addEventListener('click', function() {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœè°±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }
        
        const recipeId = document.getElementById('recipe-id').value;
        fetch(`/recipe/${recipeId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/';
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('åˆ é™¤èœè°±å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    });

    // é£Ÿææ™ºèƒ½æç¤ºåŠŸèƒ½
    function setupIngredientSuggestions(textarea) {
        let currentSuggestions = [];
        let selectedIndex = -1;
        let suggestionsList = textarea.nextElementSibling;
        
        if (!suggestionsList || !suggestionsList.classList.contains('ingredients-suggestions')) {
            suggestionsList = document.createElement('div');
            suggestionsList.className = 'ingredients-suggestions';
            suggestionsList.style.display = 'none';  // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸ºéšè—
            textarea.parentNode.insertBefore(suggestionsList, textarea.nextSibling);
        } else {
            suggestionsList.style.display = 'none';  // å¦‚æœå·²å­˜åœ¨ï¼Œä¹Ÿç¡®ä¿ä¸ºéšè—çŠ¶æ€
        }

        function showSuggestions(suggestions, startPos) {
            currentSuggestions = suggestions;
            selectedIndex = -1;
            suggestionsList.innerHTML = '';
            
            if (suggestions.length > 0) {
                suggestions.forEach((suggestion, index) => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `
                        <span class="name">${suggestion.name}</span>
                        <span class="unit">${suggestion.unit}</span>
                    `;
                    div.addEventListener('click', () => {
                        applySuggestion(suggestion, startPos);
                    });
                    div.addEventListener('mouseover', () => {
                        selectedIndex = index;
                        updateSelectedSuggestion();
                    });
                    suggestionsList.appendChild(div);
                });
                suggestionsList.style.display = 'block';
            } else {
                suggestionsList.style.display = 'none';
            }
        }

        function applySuggestion(suggestion, startPos) {
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            textarea.value = text.substring(0, startPos) + suggestion.name + text.substring(cursorPos);
            textarea.selectionStart = textarea.selectionEnd = startPos + suggestion.name.length;
            suggestionsList.style.display = 'none';
            highlightIngredients(textarea);
            textarea.focus();
        }

        function updateSelectedSuggestion() {
            const items = suggestionsList.querySelectorAll('.suggestion-item');
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        let startPos = 0;
        textarea.addEventListener('input', function() {
            const pos = this.selectionStart;
            const text = this.value;
            
            console.log('å½“å‰è¾“å…¥ä½ç½®:', pos);
            console.log('å½“å‰æ–‡æœ¬:', text);
            
            // åªè·å–æœ€åè¾“å…¥çš„å­—ç¬¦
            const currentChar = text[pos - 1] || '';
            console.log('å½“å‰è¾“å…¥å­—ç¬¦:', currentChar);
            
            if (currentChar && !/[ï¼Œã€‚,.ã€\n\s]/.test(currentChar)) {
                // åªè·å–å½“å‰è¡¨å•ä¸­å·²æ·»åŠ çš„é£Ÿæ
                const currentIngredients = Array.from(
                    document.querySelectorAll('input[name="ingredients[]"]')
                ).map(input => ({ 
                    name: input.value, 
                    unit: input.closest('.ingredient-item').querySelector('input[name="amounts[]"]').value 
                })).filter(ing => ing.name.trim() !== '');
                
                console.log('å½“å‰è¡¨å•ä¸­çš„é£Ÿæ:', currentIngredients);
                
                // åªç”¨å½“å‰å­—ç¬¦åŒ¹é…å·²æ·»åŠ çš„é£Ÿæ
                const matches = currentIngredients.filter(ing => 
                    ing.name && ing.name.toLowerCase().includes(currentChar.toLowerCase())
                );
                
                console.log('åŒ¹é…åˆ°çš„é£Ÿæ:', matches);
                if (matches.length > 0) {
                    showSuggestions(matches, pos - 1);
                } else {
                    suggestionsList.style.display = 'none';
                }
            } else {
                console.log('æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆçš„è¾“å…¥');
                suggestionsList.style.display = 'none';
            }
        });

        // é”®ç›˜å¯¼èˆª
        textarea.addEventListener('keydown', function(e) {
            if (suggestionsList.style.display === 'block') {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                    updateSelectedSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelectedSuggestion();
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        applySuggestion(currentSuggestions[selectedIndex], startPos);
                    }
                } else if (e.key === 'Escape') {
                    suggestionsList.style.display = 'none';
                }
            }
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—å»ºè®®åˆ—è¡¨
        document.addEventListener('click', function(e) {
            if (!textarea.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.style.display = 'none';
            }
        });
    }

    // è§†é¢‘é“¾æ¥æ£€æµ‹åŠŸèƒ½
    function setupVideoDetection(textarea) {
        // ç¡®ä¿è§†é¢‘é¢„è§ˆåŒºåŸŸå­˜åœ¨
        let previewContainer = textarea.nextElementSibling;
        if (!previewContainer || !previewContainer.classList.contains('video-preview')) {
            previewContainer = document.createElement('div');
            previewContainer.className = 'video-preview mt-2';
            textarea.parentNode.insertBefore(previewContainer, textarea.nextSibling);
        }

        textarea.addEventListener('input', function() {
            handleVideoLink(this.value, textarea.parentNode);
        });
    }

    // ç»Ÿä¸€çš„é“¾æ¥è§£æå¤„ç†å‡½æ•°
    function handleVideoLink(text, container) {
        // å¦‚æœæ–‡æœ¬ä¸ºç©ºï¼Œç›´æ¥è¿”å›
        if (!text || !text.trim()) {
            return;
        }

        // åŒ¹é…æ‰€æœ‰URL
        const urlRegex = /https?:\/\/[^\s]+/g;
        const urls = text.match(urlRegex);
        
        if (urls) {
            urls.forEach(url => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªé“¾æ¥
                const existingPreview = container.querySelector(`[data-video-link="${url}"]`);
                if (existingPreview) {
                    return;
                }
                
                fetch('/parse_video_url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const preview = document.createElement('div');
                        preview.className = 'video-preview mt-2';
                        preview.setAttribute('data-video-link', url);
                        
                        // æ ¹æ®URLåˆ¤æ–­å¹³å°
                        let platform = 'ğŸ”—';
                        if (url.includes('douyin.com')) {
                            platform = 'ğŸµ';
                        } else if (url.includes('bilibili.com')) {
                            platform = 'ğŸ“º';
                        }
                        
                        preview.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <span class="platform-icon me-2">${platform}</span>
                                        <span class="video-title">${data.data.title}</span>
                                        <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary ms-auto">
                                            æŸ¥çœ‹é“¾æ¥
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        const previewContainer = container.querySelector('.video-preview');
                        if (previewContainer) {
                            previewContainer.innerHTML = preview.innerHTML;
                        }
                    }
                })
                .catch(error => {
                    console.error('è§£æè§†é¢‘é“¾æ¥å¤±è´¥:', error);
                });
            });
        }
    }

    // æ·»åŠ è‡ªåŠ¨æ‰©å±•é«˜åº¦çš„å‡½æ•°
    function setupAutoExpand(textarea) {
        function autoExpand() {
            // é‡ç½®é«˜åº¦ä»¥è·å–æ­£ç¡®çš„scrollHeight
            textarea.style.height = 'auto';
            // è®¾ç½®æ–°çš„é«˜åº¦
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        
        // ç»‘å®šäº‹ä»¶
        textarea.addEventListener('input', autoExpand);
        textarea.addEventListener('focus', autoExpand);
        
        // åˆå§‹åŒ–é«˜åº¦
        // ä½¿ç”¨setTimeoutç¡®ä¿å†…å®¹å·²ç»æ¸²æŸ“å®Œæˆ
        setTimeout(autoExpand, 0);
    }

    // ä¸ºå·²æœ‰çš„æ–‡æœ¬æ¡†æ·»åŠ è‡ªåŠ¨æ‰©å±•åŠŸèƒ½
    function initializeAllTextareas() {
        document.querySelectorAll('.auto-expand').forEach(setupAutoExpand);
    }

    // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰æ–‡æœ¬æ¡†
    document.addEventListener('DOMContentLoaded', initializeAllTextareas);
    
    // åœ¨æ¨¡æ€æ¡†æ˜¾ç¤ºåä¹Ÿè§¦å‘ä¸€æ¬¡è‡ªåŠ¨å±•å¼€
    document.getElementById('recipeModal').addEventListener('shown.bs.modal', function() {
        document.querySelectorAll('.auto-expand').forEach(textarea => {
            const event = new Event('input');
            textarea.dispatchEvent(event);
        });
    });

    // åœ¨ initializeCommonIngredients å‡½æ•°ä¸­æ·»åŠ  Sortable å®ä¾‹çš„ç®¡ç†
    let commonIngredientsSortable = null;  // æ·»åŠ å…¨å±€å˜é‡æ¥è·Ÿè¸ª Sortable å®ä¾‹

    function initializeCommonIngredients(isManageMode = false) {
        const commonIngredientsList = document.getElementById('commonIngredientsList');
        
        // å¦‚æœå­˜åœ¨ä¹‹å‰çš„ Sortable å®ä¾‹ï¼Œå…ˆé”€æ¯å®ƒ
        if (commonIngredientsSortable) {
            commonIngredientsSortable.destroy();
            commonIngredientsSortable = null;
        }
        
        commonIngredientsList.innerHTML = '';
        
        fetch('/common_ingredients')
            .then(response => response.json())
            .then(ingredients => {
                ingredients.forEach(ingredient => {
                    if (isManageMode) {
                        // ç®¡ç†æ¨¡å¼ï¼šæ˜¾ç¤ºç¼–è¾‘è¡¨å•
                        const div = document.createElement('div');
                        div.className = 'common-ingredient-item';
                        div.setAttribute('data-id', ingredient.id);
                        div.innerHTML = `
                            <input type="text" value="${ingredient.name}" placeholder="é£Ÿæåç§°">
                            <input type="text" value="${ingredient.unit}" placeholder="é»˜è®¤ç”¨é‡">
                        `;
                        commonIngredientsList.appendChild(div);
                    } else {
                        // æ™®é€šæ¨¡å¼ï¼šæ˜¾ç¤ºå¿«é€Ÿé€‰æ‹©æŒ‰é’®
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-sm btn-outline-primary m-1';
                        btn.textContent = ingredient.name;
                        btn.setAttribute('data-id', ingredient.id);
                        btn.addEventListener('click', () => addIngredientWithValues('ingredientsList', ingredient.name, ingredient.unit));
                        commonIngredientsList.appendChild(btn);
                    }
                });

                if (isManageMode) {
                    // åœ¨ç®¡ç†æ¨¡å¼ä¸‹æ·»åŠ æ–°çš„ç©ºç™½è¾“å…¥è¡Œ
                    const newDiv = document.createElement('div');
                    newDiv.className = 'common-ingredient-item';
                    newDiv.innerHTML = `
                        <input type="text" placeholder="æ–°é£Ÿæåç§°">
                        <input type="text" placeholder="é»˜è®¤ç”¨é‡">
                    `;
                    commonIngredientsList.appendChild(newDiv);

                    // è®¾ç½®æ–°é£Ÿæå¤„ç†
                    setupNewIngredientHandling();
                } else {
                    // æ™®é€šæ¨¡å¼çš„æ‹–åŠ¨æ’åº
                    commonIngredientsSortable = new Sortable(commonIngredientsList, {
                        animation: 150,
                        onEnd: saveCommonIngredientsOrder,
                        // æ·»åŠ ç§»åŠ¨ç«¯æ‰€éœ€çš„é…ç½®
                        ghostClass: 'sortable-ghost',  // æ‹–åŠ¨æ—¶çš„æ ·å¼ç±»
                        touchStartThreshold: 3,  // å¼€å§‹æ‹–åŠ¨çš„é˜ˆå€¼
                        delay: 150,  // å»¶è¿Ÿå¼€å§‹æ‹–åŠ¨ï¼Œé˜²æ­¢è¯¯è§¦
                        delayOnTouchOnly: true,  // ä»…åœ¨è§¦æ‘¸æ—¶åº”ç”¨å»¶è¿Ÿ
                        forceFallback: true,  // å¼ºåˆ¶ä½¿ç”¨å›é€€é€‰é¡¹ä»¥ç¡®ä¿è·¨å¹³å°ä¸€è‡´æ€§
                        fallbackClass: 'sortable-fallback',  // å›é€€æ—¶çš„æ ·å¼ç±»
                        fallbackOnBody: true,  // å°† ghost å…ƒç´ æ·»åŠ åˆ° body
                        dragClass: 'sortable-drag'  // æ‹–åŠ¨æ—¶çš„æ ·å¼ç±»
                    });
                }
            })
            .catch(error => {
                console.error('è·å–å¸¸ç”¨é£Ÿæå¤±è´¥:', error);
            });
    }

    // ä¿®æ”¹ç®¡ç†æŒ‰é’®çš„åˆ‡æ¢æ ·å¼
    document.getElementById('manageCommonIngredients').addEventListener('click', function() {
        const isManageMode = this.getAttribute('data-manage-mode') === 'true';
        if (!isManageMode) {
            // åˆ‡æ¢åˆ°ç®¡ç†æ¨¡å¼
            this.textContent = 'ğŸ’¾ ä¿å­˜';
            this.style.backgroundColor = '#ff9999';
            this.style.color = 'white';
            this.setAttribute('data-manage-mode', 'true');
            initializeCommonIngredients(true);
        } else {
            // ä¿å­˜æ›´æ”¹å¹¶åˆ‡æ¢å›æ™®é€šæ¨¡å¼
            saveCommonIngredients().then(() => {
                this.textContent = 'âš™ï¸ ç®¡ç†';
                this.style.backgroundColor = '';
                this.style.color = '#ff9999';
                this.setAttribute('data-manage-mode', 'false');
                initializeCommonIngredients(false);
            });
        }
    });

    // æ·»åŠ ä¿å­˜å¸¸ç”¨é£Ÿæçš„å‡½æ•°
    async function saveCommonIngredients() {
        const items = Array.from(document.querySelectorAll('.common-ingredient-item')).map((el, index) => {
            const inputs = el.querySelectorAll('input');
            const id = el.getAttribute('data-id');
            return {
                id: id ? parseInt(id) : null,
                name: inputs[0].value.trim(),
                unit: inputs[1].value.trim(),
                order: index
            };
        }).filter(item => item.name); // è¿‡æ»¤æ‰ç©ºåç§°çš„é¡¹

        try {
            const response = await fetch('/common_ingredients/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(items)
            });
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜å¸¸ç”¨é£Ÿæå¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            throw error;
        }
    }

    // ä¿å­˜æ’åºçš„å‡½æ•°
    function saveCommonIngredientsOrder() {
        const items = Array.from(document.getElementById('commonIngredientsList').children).map((el, index) => ({
            id: parseInt(el.getAttribute('data-id')),
            order: index
        }));
        
        fetch('/common_ingredients/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(items)
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('ä¿å­˜æ’åºå¤±è´¥:', data.error);
            }
        })
        .catch(error => {
            console.error('ä¿å­˜æ’åºæ—¶å‘ç”Ÿé”™è¯¯:', error);
        });
    }

    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å‡½æ•°
    function setupNewIngredientHandling() {
        const commonIngredientsList = document.getElementById('commonIngredientsList');
        
        // ä¸ºæ‰€æœ‰ç°æœ‰çš„è¾“å…¥æ¡†è°ƒæ•´å®½åº¦
        commonIngredientsList.querySelectorAll('input').forEach(adjustInputWidth);
        
        // ç›‘å¬æ‰€æœ‰è¾“å…¥æ¡†çš„è¾“å…¥äº‹ä»¶
        commonIngredientsList.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT') {
                adjustInputWidth(e.target);
                
                const currentItem = e.target.closest('.common-ingredient-item');
                const isLastItem = currentItem === commonIngredientsList.lastElementChild;
                
                if (isLastItem && e.target.value.trim() !== '') {
                    const newDiv = document.createElement('div');
                    newDiv.className = 'common-ingredient-item';
                    newDiv.innerHTML = `
                        <input type="text" placeholder="æ–°é£Ÿæåç§°">
                        <input type="text" placeholder="é»˜è®¤ç”¨é‡">
                    `;
                    commonIngredientsList.appendChild(newDiv);
                    // ä¸ºæ–°æ·»åŠ çš„è¾“å…¥æ¡†è°ƒæ•´å®½åº¦
                    newDiv.querySelectorAll('input').forEach(adjustInputWidth);
                }
            }
        });

        // æ·»åŠ é€€æ ¼é”®å¤„ç†
        commonIngredientsList.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                const input = e.target;
                if (input.tagName === 'INPUT') {
                    const currentItem = input.closest('.common-ingredient-item');
                    const inputs = currentItem.querySelectorAll('input');
                    const nameInput = inputs[0];
                    const unitInput = inputs[1];

                    // å¦‚æœæ˜¯ç”¨é‡è¾“å…¥æ¡†ï¼Œä¸”å†…å®¹ä¸ºç©ºï¼Œä¸”å…‰æ ‡åœ¨å¼€å§‹ä½ç½®
                    if (input === unitInput && input.value === '' && input.selectionStart === 0) {
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é€€æ ¼è¡Œä¸º
                        nameInput.focus(); // èšç„¦åˆ°é£Ÿæåç§°è¾“å…¥æ¡†
                        nameInput.selectionStart = nameInput.value.length; // å°†å…‰æ ‡ç§»åˆ°æ–‡æœ¬æœ«å°¾
                    }
                }
            }
        });
        
        // ç›‘å¬æ‰€æœ‰è¾“å…¥æ¡†çš„å¤±å»ç„¦ç‚¹äº‹ä»¶
        commonIngredientsList.addEventListener('blur', function(e) {
            if (e.target.tagName === 'INPUT') {
                const currentItem = e.target.closest('.common-ingredient-item');
                const inputs = currentItem.querySelectorAll('input');
                const nameInput = inputs[0];
                const unitInput = inputs[1];
                
                // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªé¡¹ç›®ï¼Œä¸”åç§°ä¸ºç©ºï¼Œåˆ™åˆ é™¤è¯¥é¡¹
                if (currentItem !== commonIngredientsList.lastElementChild && 
                    nameInput.value.trim() === '') {
                    currentItem.remove();
                }
            }
        }, true);
    }

    // æ·»åŠ è‡ªåŠ¨è°ƒæ•´å®½åº¦çš„JavaScript
    function adjustInputWidth(input) {
        const tempSpan = document.createElement('span');
        tempSpan.style.font = window.getComputedStyle(input).font;
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.whiteSpace = 'pre';
        document.body.appendChild(tempSpan);
        
        tempSpan.textContent = input.value || input.placeholder;
        const width = tempSpan.offsetWidth;
        document.body.removeChild(tempSpan);
        
        // å¢åŠ æ›´å¤šçš„paddingç©ºé—´ï¼Œä»10pxæ”¹ä¸º20px
        input.style.width = (width + 20) + 'px';
    }

    // å¯¼å‡ºåˆå§‹åŒ–å‡½æ•°ä¾›å¤–éƒ¨ä½¿ç”¨
    window.initializeRecipeModal = initializeModal;
});
</script> 